(window.webpackJsonp=window.webpackJsonp||[]).push([[338],{396:function(e,n,t){"use strict";t.r(n),t.d(n,"frontMatter",(function(){return o})),t.d(n,"metadata",(function(){return c})),t.d(n,"rightToc",(function(){return s})),t.d(n,"default",(function(){return p}));var r=t(1),a=t(6),i=(t(0),t(485)),o={title:"\u6d41\u7a0b\u89e6\u53d1\u5668"},c={unversionedId:"help/workflow/flow_webhooks",id:"help/workflow/flow_webhooks",isDocsHomePage:!1,title:"\u6d41\u7a0b\u89e6\u53d1\u5668",description:"\u5f53\u7528\u6237\u63d0\u4ea4\u63d0\u4ea4\u67d0\u4e9b\u7533\u8bf7\u5355\u65f6\uff0c\u9700\u8981\u6267\u884c\u989d\u5916\u7684\u64cd\u4f5c\uff0c\u5982\u53d1\u9001\u77ed\u4fe1\u3001\u53d1\u9001\u90ae\u4ef6\u7b49\u3002\u5173\u4e8e\u6b64\u7c7b\u989d\u5916\u64cd\u4f5c\uff0c\u7ba1\u7406\u5458\u53ef\u901a\u8fc7\u914d\u7f6e \u6d41\u7a0b\u89e6\u53d1\u5668 \u6765\u5b8c\u6210\u3002",source:"@site/../docs/help/workflow/flow_webhooks.md",slug:"/help/workflow/flow_webhooks",permalink:"/help/workflow/flow_webhooks",version:"current",sidebar:"\u6587\u6863",previous:{title:"\u5220\u9664",permalink:"/developer/api/graphql_delete"},next:{title:"\u81ea\u5b9a\u4e49\u6309\u94ae",permalink:"/developer/object_action"}},s=[{value:"\u914d\u7f6e",id:"\u914d\u7f6e",children:[]},{value:"\u89e6\u53d1\u6761\u4ef6",id:"\u89e6\u53d1\u6761\u4ef6",children:[]},{value:"\u793a\u4f8b",id:"\u793a\u4f8b",children:[]}],l={rightToc:s};function p(e){var n=e.components,t=Object(a.a)(e,["components"]);return Object(i.b)("wrapper",Object(r.a)({},l,t,{components:n,mdxType:"MDXLayout"}),Object(i.b)("p",null,"\u5f53\u7528\u6237\u63d0\u4ea4\u63d0\u4ea4\u67d0\u4e9b\u7533\u8bf7\u5355\u65f6\uff0c\u9700\u8981\u6267\u884c\u989d\u5916\u7684\u64cd\u4f5c\uff0c\u5982\u53d1\u9001\u77ed\u4fe1\u3001\u53d1\u9001\u90ae\u4ef6\u7b49\u3002\u5173\u4e8e\u6b64\u7c7b\u989d\u5916\u64cd\u4f5c\uff0c\u7ba1\u7406\u5458\u53ef\u901a\u8fc7\u914d\u7f6e \u6d41\u7a0b\u89e6\u53d1\u5668 \u6765\u5b8c\u6210\u3002"),Object(i.b)("h2",{id:"\u914d\u7f6e"},"\u914d\u7f6e"),Object(i.b)("p",null,"\u5728\u7cfb\u7edf\u8bbe\u7f6e\u9875\u9762\uff0c\u7ba1\u7406\u5458\u9700\u8981\u5bf9\u76f8\u5173\u53c2\u6570\u8fdb\u884c\u914d\u7f6e\u3002"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"\u914d\u7f6e\u53c2\u6570",Object(i.b)("ul",{parentName:"li"},Object(i.b)("li",{parentName:"ul"},"\u6d41\u7a0b\uff1a\u9009\u62e9\u914d\u7f6e\u7684\u6d41\u7a0b\uff0c\u6570\u636e\u5e93\u4e2d\u4fdd\u5b58\u6d41\u7a0b ID"),Object(i.b)("li",{parentName:"ul"},"URL\uff1a\u89e6\u53d1\u7684 URL \u8def\u5f84"),Object(i.b)("li",{parentName:"ul"},"\u6fc0\u6d3b\uff1a\u9ed8\u8ba4\u4e0d\u6fc0\u6d3b\uff0c\u53ea\u6709\u6fc0\u6d3b\u72b6\u6001\u7684 \u6d41\u7a0b\u89e6\u53d1\u5668 \u624d\u4f1a\u89e6\u53d1\u64cd\u4f5c"),Object(i.b)("li",{parentName:"ul"},"\u63cf\u8ff0\uff1a\u64cd\u4f5c\u7684\u6587\u5b57\u63cf\u8ff0\u5185\u5bb9")))),Object(i.b)("h2",{id:"\u89e6\u53d1\u6761\u4ef6"},"\u89e6\u53d1\u6761\u4ef6"),Object(i.b)("p",null,"\u5f53\u7528\u6237\u64cd\u4f5c\u7533\u8bf7\u5355\u65f6\uff08\u5305\u62ec\u53d1\u9001\u3001\u4f20\u9605\u3001\u53d6\u56de\u7b49\uff09\uff0c\u7cfb\u7edf\u5c06\u67e5\u627e\u5f53\u524d\u7533\u8bf7\u5355\u914d\u7f6e\u7684 \u6d41\u7a0b\u89e6\u53d1\u5668\uff0c\u5982\u67e5\u5230\u4e14\u662f\u6fc0\u6d3b\u72b6\u6001\uff0c\u5219\u89e6\u53d1 \u6d41\u7a0b\u89e6\u53d1\u5668\u3002\u5373\u5411\u914d\u7f6e\u7684 URL \u53d1\u9001 POST \u8bf7\u6c42\u3002\u5176\u4e2d\uff0c\u8bf7\u6c42\u7684 body \u6570\u636e\u4e3b\u8981\u6709\u4ee5\u4e0b\u90e8\u5206\u3002"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},"action\uff1a\u89e6\u53d1\u6b64 hook \u65f6\u7684\u64cd\u4f5c\uff0c\u5176\u503c\u57df\u5982\u4e0b\uff1a"),Object(i.b)("p",{parentName:"li"},"draft_submit\uff1a\u8349\u7a3f\u7bb1\u63d0\u4ea4,"),Object(i.b)("p",{parentName:"li"},"engine_submit\uff1a\u5f85\u5ba1\u6838\u63d0\u4ea4,"),Object(i.b)("p",{parentName:"li"},"reassign\uff1a\u8f6c\u7b7e\u6838,"),Object(i.b)("p",{parentName:"li"},"relocate\uff1a\u91cd\u5b9a\u4f4d,"),Object(i.b)("p",{parentName:"li"},"retrieve\uff1a\u53d6\u56de,"),Object(i.b)("p",{parentName:"li"},"terminate\uff1a\u53d6\u6d88\u7533\u8bf7,"),Object(i.b)("p",{parentName:"li"},"cc_do\uff1a\u4f20\u9605\u7ed9\u4ed6\u4eba,"),Object(i.b)("p",{parentName:"li"},"cc_submit\uff1a\u88ab\u4f20\u9605\u63d0\u4ea4")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},"current_approve\uff1a\u5f53\u524d\u6b65\u9aa4\uff0c\u5373\u7528\u6237\u6267\u884c\u63d0\u4ea4\u64cd\u4f5c\u65f6\u7684 approve \u6570\u636e\uff0c\u5305\u542b\u4e3b\u8981\u5b57\u6bb5\uff1a"),Object(i.b)("ul",{parentName:"li"},Object(i.b)("li",{parentName:"ul"},"judge\uff1a\u5f53\u524d\u6b65\u9aa4\u5904\u7406\u4eba\u610f\u89c1\uff0capproved \u8868\u793a\u6838\u51c6\uff0crejected \u8868\u793a\u9a73\u56de\uff0csubmitted \u8868\u793a\u586b\u5199\u8282\u70b9\u63d0\u4ea4"))),Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},"instance\uff1a\u63d0\u4ea4\u7533\u8bf7\u5355\u64cd\u4f5c\u5b8c\u6210\u540e\u6700\u65b0\u7684\u5b8c\u6574\u5b9e\u4f8b\u6570\u636e\uff0c \u5305\u542b\u4e3b\u8981\u5b57\u6bb5\uff1a"),Object(i.b)("ul",{parentName:"li"},Object(i.b)("li",{parentName:"ul"},"name\uff1a\u7533\u8bf7\u5355\u540d\u79f0"),Object(i.b)("li",{parentName:"ul"},"applicant_name\uff1a\u7533\u8bf7\u4eba\u540d\u79f0"),Object(i.b)("li",{parentName:"ul"},"applicant_organization_name\uff1a\u7533\u8bf7\u4eba\u6240\u5c5e\u7ec4\u7ec7\u540d\u79f0"),Object(i.b)("li",{parentName:"ul"},"applicant_organization_fullname\uff1a\u7533\u8bf7\u4eba\u6240\u5c5e\u7ec4\u7ec7\u5168\u8def\u5f84"),Object(i.b)("li",{parentName:"ul"},"current_step_name\uff1a \u5f53\u524d\u6b65\u9aa4\u540d\u79f0"),Object(i.b)("li",{parentName:"ul"},"state\uff1a\u7533\u8bf7\u5355\u72b6\u6001\uff0c pending \u8868\u793a\u8fdb\u884c\u4e2d\uff0ccompleted \u8868\u793a\u5df2\u7ed3\u675f"),Object(i.b)("li",{parentName:"ul"},"final_decision\uff1a\u7533\u8bf7\u5355\u6700\u7ec8\u5904\u7406\u610f\u89c1\uff0c\u7533\u8bf7\u5355\u7ed3\u675f\u65f6\u8d4b\u503c\uff0capproved \u8868\u793a\u6838\u51c6\uff0crejected \u8868\u793a\u9a73\u56de\uff0cterminated \u8868\u793a\u5f3a\u5236\u7ed3\u675f"))),Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},"from_user\uff1a\u503c\u4e3a\u5f53\u524d\u64cd\u4f5c\u8005\u3002\u5982\uff1a A \u63d0\u4ea4\u7533\u8bf7\u5355\u7ed9 B \u90a3\u4e48 from_user \u503c\u5c31\u662f A \u7684\u76f8\u5173\u4fe1\u606f"),Object(i.b)("ul",{parentName:"li"},Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},"_","id\uff1a\u7528\u6237\u5728\u5ba1\u6279\u738b\u7684\u552f\u4e00\u6807\u8bc6\u7b26")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},"email\uff1a\u7528\u6237\u5728\u5ba1\u6279\u738b\u7684\u552f\u4e00\u4e3b\u90ae\u7bb1\uff08space_users \u8868\u5b57\u6bb5\uff09")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},"username\uff1a\u7528\u6237\u5728\u5ba1\u6279\u738b\u7684\u767b\u5f55\u540d")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},"mobile\uff1a\u7528\u6237\u5728\u5ba1\u6279\u738b\u7684\u624b\u673a\u53f7\uff08space_users \u8868\u5b57\u6bb5\uff09")))),Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},"to_users\uff1a\u503c\u4e3a\u5f53\u524d\u4e0b\u4e00\u6b65\u9aa4\u5904\u7406\u4eba\u96c6\u5408,\u96c6\u5408\u5185\u5bf9\u8c61\u7684\u5c5e\u6027\u4e0e from_user \u76f8\u540c\u3002"))),Object(i.b)("p",null,"\u8bf7\u6c42\u7684 body \u6570\u636e\u793a\u4f8b\u5982\u4e0b\uff1a"),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{className:"language-json"}),'{\n  "action": "draft_submit",\n  "from_user": {\n    "_id": "TPWYx597AuLSksSDH",\n    "email": "AAA@hotoa.com",\n    "username": "AAA",\n    "mobile": "171****6263"\n  },\n  "to_users": [\n    {\n      "_id": "snLab9tq6bHquJjof",\n      "email": "BBB@hotoa.com",\n      "username": "BBB",\n      "mobile": "171****6263"\n    },\n    {\n      "_id": "hJChDEqfCh5MQ2tGj",\n      "email": "CCC@hotoa.com",\n      "username": "CCC",\n      "mobile": "171****6263"\n    }\n  ],\n  "current_approve": {\n    "_id": "8ecbd6be43193e650e8d913f",\n    "instance": "HjHvRxp5vFL5fn7uK",\n    "trace": "b0f6eadb4b7909538778d766",\n    "is_finished": false,\n    "user": "hPgDcEd9vKQxwndQR",\n    "user_name": "MJ",\n    "handler": "hPgDcEd9vKQxwndQR",\n    "handler_name": "MJ",\n    "handler_organization": "593b97230cda012fa65270f9",\n    "handler_organization_name": "\u534e\u708e\u8f6f\u4ef6",\n    "handler_organization_fullname": "\u534e\u708e\u8f6f\u4ef6",\n    "type": "draft",\n    "is_read": true,\n    "is_error": false,\n    "description": "",\n    "values": {\n      "\u62df\u7a3f\u4eba": "MJ",\n      "\u65e5\u671f-\u65f6\u95f4": "",\n      "\u65e5\u671f": "",\n      "\u6587\u4ef6\u6807\u9898": "\u516c\u53f8\u53d1\u6587",\n      "\u4e0b\u62c9\u6846": "",\n      "\u591a\u9009": ""\n    },\n    "judge": "submitted",\n    "next_steps": [\n      {\n        "step": "b65e5d4a-3d52-4aa6-a7c9-260cb7242ca6",\n        "users": ["hPgDcEd9vKQxwndQR"]\n      }\n    ]\n  },\n  "instance": {\n    "_id": "HjHvRxp5vFL5fn7uK",\n    "space": "Af8eM6mAHo7wMDqD3",\n    "flow": "0c09ae80-6e44-4d77-96f7-c1efa19e26ce",\n    "flow_version": "561295cb-c262-4ee3-9659-2f6350155406",\n    "form": "6B0DCFC3-1E39-4F70-8C5D-E80C135CD70D",\n    "form_version": "672de6ce-e372-48e9-b1d3-830b46819b0b",\n    "name": "\u516c\u53f8\u53d1\u6587",\n    "submitter": "hPgDcEd9vKQxwndQR",\n    "submitter_name": "MJ",\n    "applicant": "hPgDcEd9vKQxwndQR",\n    "applicant_name": "MJ",\n    "applicant_organization": "593b97230cda012fa65270f9",\n    "applicant_organization_name": "\u534e\u708e\u8f6f\u4ef6",\n    "applicant_organization_fullname": "\u534e\u708e\u8f6f\u4ef6",\n    "state": "pending",\n    "code": "21",\n    "is_archived": false,\n    "is_deleted": false,\n    "values": {\n      "\u62df\u7a3f\u4eba": "MJ",\n      "\u65e5\u671f-\u65f6\u95f4": "",\n      "\u65e5\u671f": "",\n      "\u6587\u4ef6\u6807\u9898": "\u516c\u53f8\u53d1\u6587",\n      "\u4e0b\u62c9\u6846": "",\n      "\u591a\u9009": ""\n    },\n    "traces": [\n      {\n        "_id": "b0f6eadb4b7909538778d766",\n        "instance": "HjHvRxp5vFL5fn7uK",\n        "is_finished": true,\n        "step": "9b680fbe-0429-4dc8-913e-688c4cbebd3b",\n        "name": "\u62df\u7a3f\u4eba\u62df\u7a3f",\n        "start_date": "2017-12-08T09:00:52.422Z",\n        "approves": [\n          {\n            "_id": "8ecbd6be43193e650e8d913f",\n            "instance": "HjHvRxp5vFL5fn7uK",\n            "trace": "b0f6eadb4b7909538778d766",\n            "is_finished": true,\n            "user": "hPgDcEd9vKQxwndQR",\n            "user_name": "MJ",\n            "handler": "hPgDcEd9vKQxwndQR",\n            "handler_name": "MJ",\n            "handler_organization": "593b97230cda012fa65270f9",\n            "handler_organization_name": "\u534e\u708e\u8f6f\u4ef6",\n            "handler_organization_fullname": "\u534e\u708e\u8f6f\u4ef6",\n            "type": "draft",\n            "is_read": true,\n            "is_error": false,\n            "description": "",\n            "values": {\n              "\u62df\u7a3f\u4eba": "MJ",\n              "\u65e5\u671f-\u65f6\u95f4": "",\n              "\u65e5\u671f": "",\n              "\u6587\u4ef6\u6807\u9898": "\u516c\u53f8\u53d1\u6587",\n              "\u4e0b\u62c9\u6846": "",\n              "\u591a\u9009": ""\n            },\n            "judge": "submitted",\n            "next_steps": [\n              {\n                "step": "b65e5d4a-3d52-4aa6-a7c9-260cb7242ca6",\n                "users": ["hPgDcEd9vKQxwndQR"]\n              }\n            ],\n            "cost_time": 177759\n          }\n        ],\n        "judge": "submitted"\n      }\n    ],\n    "inbox_users": ["hPgDcEd9vKQxwndQR"],\n    "current_step_name": "\u4e3b\u4efb\u7b7e\u53d1",\n    "submit_date": "2017-12-08T09:03:50.189Z",\n    "outbox_users": [],\n    "keywords": ""\n  }\n}\n')),Object(i.b)("h2",{id:"\u793a\u4f8b"},"\u793a\u4f8b"),Object(i.b)("p",null,"\u9886\u5bfc\u6709\u5ba1\u6279\u610f\u89c1\u65f6\u901a\u77e5\u6587\u4e66\uff0c\u7ed9\u6587\u4e66\u53d1\u9001\u77ed\u4fe1\uff0c\u65b0\u5efa wenshu.router.js\uff0c","*",".router.js \u6587\u6863\u53c2\u8003",Object(i.b)("a",Object(r.a)({parentName:"p"},{href:"https://www.steedos.com/developer/api/router"}),"\u81ea\u5b9a\u4e49 API"),"\uff1a"),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{className:"language-js"}),'const express = require("express");\nconst router = express.Router();\n\nrouter.post("/api/flow_webhook/notify/wenshu", function (req, res) {\n  try {\n    var current_approve,\n      description,\n      e,\n      hashData,\n      ins_description,\n      ins_name,\n      lang,\n      name,\n      params,\n      user;\n    hashData = req.body;\n    if (hashData.action !== "engine_submit") {\n      res.status(200).send({});\n      return;\n    }\n    if (\n      _.isEmpty(hashData) ||\n      _.isEmpty(hashData.instance) ||\n      _.isEmpty(hashData.current_approve)\n    ) {\n      throw new Error("error", "\u4e0d\u5177\u5907hook\u6267\u884c\u6761\u4ef6");\n    }\n    current_approve = hashData.current_approve;\n    if (current_approve.handler_name === "\u5f20\u603b") {\n      if (current_approve.description) {\n        user = db.users.findOne(\n          {\n            "emails.address": "steedos@steedos.com",\n          },\n          {\n            fields: {\n              mobile: 1,\n              locale: 1,\n            },\n          }\n        );\n        if (user && user.mobile) {\n          //\u8bbe\u7f6e\u5f53\u524d\u8bed\u8a00\u73af\u5883\n          lang = "en";\n          if (user.locale === "zh-cn") {\n            lang = "zh-CN";\n          }\n          ins_name = hashData.instance.name;\n          ins_description = current_approve.description;\n          name =\n            ins_name.length > 15 ? ins_name.substr(0, 12) + "..." : ins_name;\n          description =\n            ins_description.length > 15\n              ? ins_description.substr(0, 12) + "..."\n              : ins_description;\n          params = {\n            handler: current_approve.handler_name,\n            instance: name,\n            description: description,\n          };\n          // \u53d1\u9001\u624b\u673a\u77ed\u4fe1\n          SMSQueue.send({\n            RecNum: user.mobile,\n            msg: TAPi18n.__(\n              "sms.notify_wenshu.template",\n              {\n                handler: params.handler,\n                instance: ins_name,\n                description: ins_description,\n              },\n              lang\n            ),\n          });\n        }\n      }\n    }\n    res.status(200).send({ message: "ok" });\n  } catch (error) {\n    console.error(error.stack);\n    res.status(500).send({\n      errors: [\n        {\n          errorMessage: error.message,\n        },\n      ],\n    });\n  }\n});\n\nexports.default = router;\n')))}p.isMDXComponent=!0},485:function(e,n,t){"use strict";t.d(n,"a",(function(){return b})),t.d(n,"b",(function(){return m}));var r=t(0),a=t.n(r);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function c(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var l=a.a.createContext({}),p=function(e){var n=a.a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):c({},n,{},e)),t},b=function(e){var n=p(e.components);return a.a.createElement(l.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.a.createElement(a.a.Fragment,{},n)}},d=Object(r.forwardRef)((function(e,n){var t=e.components,r=e.mdxType,i=e.originalType,o=e.parentName,l=s(e,["components","mdxType","originalType","parentName"]),b=p(t),d=r,m=b["".concat(o,".").concat(d)]||b[d]||u[d]||i;return t?a.a.createElement(m,c({ref:n},l,{components:t})):a.a.createElement(m,c({ref:n},l))}));function m(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=t.length,o=new Array(i);o[0]=d;var c={};for(var s in n)hasOwnProperty.call(n,s)&&(c[s]=n[s]);c.originalType=e,c.mdxType="string"==typeof e?e:r,o[1]=c;for(var l=2;l<i;l++)o[l]=t[l];return a.a.createElement.apply(null,o)}return a.a.createElement.apply(null,t)}d.displayName="MDXCreateElement"}}]);